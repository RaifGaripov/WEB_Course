{% extends 'main/base.html' %}
{% load static %}
{% block title %}
Информация о подкасте
{% endblock %}

{% block javascript %}
<script>
        $( document ).ready(function() {
            // to count listened
            document.getElementById("listen_btn").style.display = "none";
            var aud = document.getElementById("audio");
            aud[0].onended = function (){
                this.load();
            }
            aud.onplay = function() {
                document.getElementById("listen_btn").click();}


            //ajax form to show likes
            $('.like-form').submit(function(e){
                e.preventDefault()

                const podcast_id = $(this).attr('id')

                const likeText = $(`.like-btn${podcast_id}`).text()
                const trim = $.trim(likeText)

                const url = $(this).attr('action')

                let res;
                const likes = $(`.like-count${podcast_id}`).text()
                const trimCount = parseInt(likes)

                $.ajax({
                    type: 'POST',
                    url: url,
                    data: {
                        'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val(),
                        'podcast_id':podcast_id,
                    },
                    success: function(response) {
                        if(trim === 'Unlike') {
                            $(`.like-btn${podcast_id}`).text('Like')
                            res = trimCount - 1
                        } else {
                            $(`.like-btn${podcast_id}`).text('Unlike')
                            res = trimCount + 1
                        }

                        $(`.like-count${podcast_id}`).text(res)
                    },
                    error: function(response) {
                        console.log('error', response)
                    }
                })

            })

            $('.listen-form').submit(function(e){
                e.preventDefault()

                const podcast_id = $('.like-form').attr('id')

                const listenText = $(`.listen-btn${podcast_id}`).text()
                const trim = $.trim(listenText)

                const url = $(this).attr('action')

                let res;
                const listened = $(`.listen-count${podcast_id}`).text()
                const trimCount = parseInt(listened)

                $.ajax({
                    type: 'POST',
                    url: url,
                    data: {
                        'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val(),
                        'podcast_id':podcast_id,
                    },
                    success: function(response) {
                        if(trim === 'Listened') {
                            $(`.listen-btn${podcast_id}`).text('Unlistened')
                            res = trimCount + 1
                        }
                        $(`.listen-count${podcast_id}`).text(res)
                    },
                    error: function(response) {
                        console.log('error', response)
                    }
                })
            })
        });
    </script>



{% endblock %}

{% block content %}

    <script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
    <h1>{{podcast.title}}</h1>
    <small>Автор: {{podcast.author}}</small><br/>
    <hr>
    <br/> {{podcast.descript}}

    <br/> {{podcast.category}}
    <br/> {{podcast.post_date}}
    <br/> {{podcast.duration}}
    <br/><br/>
    {% if podcast.image %}
        <br/> <img src="{{podcast.image.url}} ">
    {% endif %}



     {% if podcast.file %}
        <audio id="audio" controls="true">
            <source src =" {{podcast.file.url}}">
        </audio>






    {% endif %}



    <br/><br/>


    <div class="right floated">
                        <form action="{% url 'like-podcast-view' %}" method="POST" class='like-form' id='{{podcast.id}}'>
                            {% csrf_token %}
                            <input type="hidden" name="podcast_id" value={{podcast.id}}>

                                <button type="submit" class="ui button like-btn{{podcast.id}}">
                                    {% if user not in podcast.likes.all %}
                                        Like
                                    {% else %}
                                        Unlike
                                    {% endif %}
                                </button>
                                <div class="ui grid">
                                    <div class="column">
                                        <div class="like-count{{podcast.id}}"> {{podcast.likes.count}} </div>
                                    </div>
                                    <div class="column">
                                        likes
                                    </div>
                                </div>
                        </form>
    </div>

    <div class="right floated">
                        <form action="{% url 'listen-view' %}" method="POST" class='listen-form' id="second_form">
                            {% csrf_token %}
                            <input type="hidden" name="podcast_id" value={{podcast.id}}>

                                <button type="submit" class="ui button listen-btn{{podcast.id}}" id="listen_btn">
                                    {% if user not in podcast.listened.all %}
                                        Listened
                                    {% else %}
                                        Unlistened
                                    {% endif %}
                                </button>
                                <div class="ui grid">
                                    <div class="column">
                                        <div class="listen-count{{podcast.id}}"> {{podcast.listened.count}} </div>
                                    </div>
                                    <div class="column">
                                        listened
                                    </div>
                                </div>
                        </form>
    </div>
{% endblock %}
